<!DOCTYPE HTML>
	<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Sockettester</title>
		<script src="js/jquery.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://maps.googleapis.com/maps/api/js?sensor=false" type="text/javascript"></script>
    
		<script type="text/javascript" charset="utf-8">
		
			
			var ws = null;
			var host = "localhost"
			var port = 8080
			var socket = "p5websocket"
			var pause = 0;
			
			function ready(){
			  var fenway = new google.maps.LatLng(42.345573,-71.098326);
        panoOptions = {
          position: fenway,
          addressControlOptions: {
            position: google.maps.ControlPosition.BOTTOM
          },
          linksControl: false,
          panControl: false,
          zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL
          },
          enableCloseButton: false
        };

        panorama = new google.maps.StreetViewPanorama( document.getElementById("pano"), panoOptions);
			
			
				console.log("trying to open a websocket")
				var _socket = (undefined==socket)?"":"/"+socket
				ws = new WebSocket("ws://"+host+":"+port+_socket)
				var faceMapScalingX = 60;
				var faceMapScalingY = 100;
				var faceMapScalingZ = 10;
				var xoffLast = 0;
				ws.onmessage = function (e) {
          // $('#log').text(e.data+$('#log').text())
          var face = e.data.split(",")
          // console.log(face)
          var xoff = parseFloat(face[0])
          var yoff = parseFloat(face[1])
          var z    = parseFloat(face[2])
          if( Math.abs(xoffLast - xoff) > 0.01 ) {
            var currPov = panorama.getPov()
            // console.log(xoff)
            // console.log( currPov.heading + xoff*faceMapScalingX )
            panorama.setPov({
              'heading': currPov.heading + xoff*faceMapScalingX,
              'pitch'  : 10,// yoff*faceMapScalingY,
              'zoom'   : 1// z*faceMapScalingZ
            })
             xoffLast = xoff;
          }
          
				};
			}
						
			document.addEventListener("DOMContentLoaded", ready, false);
			document.addEventListener("keypress", function(d){
			  pause = Math.abs(pause-1)
			  console.log(pause)
			}, false)
			function difference(link) {
        return Math.abs(panorama.getPov().heading%360 - link.heading);
      }

      function moveForward() {
        var curr;
        for(i=0; i < panorama.links.length; i++) {
          var differ = difference(panorama.links[i]);
          if(curr == undefined) {
            curr = panorama.links[i];
          }
          if(difference(curr) > differ) {
            curr = panorama.links[i];
          }
        }
        panorama.setPano(curr.pano);
      }
      setInterval( move, 1000 );
			function move(){ 
			  if( pause != 0){
			     moveForward()
			  } else {
			    console.log('paused')
			  }
			}
		</script>
	</head>
	<body>
		<div id="test-target">

    <div id="pano" style="width: 1000.0px; height: 600.0px"></div>
		</div>
		<div id="log">
			
		</div>
	</body>
	</html>